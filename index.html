<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø·Ù„Ø§ ÛŒØ§Ø± - Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/iranyekan" rel="stylesheet">
    <link rel="stylesheet" href="fonts.css">
    <link href="https://fonts.cdnfonts.com/css/b-titr" rel="stylesheet">
    <style>
        :root {
            /* Dark Mode Colors (Default) */
            --bg-gradient-start: #0f2027;
            --bg-gradient-mid: #203a43;
            --bg-gradient-end: #2c5364;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(255, 255, 255, 0.05);
            --input-border: rgba(212, 175, 55, 0.3);
            --gold-primary: #d4af37;
            --gold-secondary: rgba(212, 175, 55, 0.2);
            --profit-color: #34c759;
            --loss-color: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.3);
            --item-bg: rgba(255, 255, 255, 0.05);
            --alert-item-bg: rgba(255, 255, 255, 0.05);
            --nav-bg: rgba(255, 255, 255, 0.08);
        }

        body.light-mode {
            /* Light Mode Colors */
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-mid: #e8ecf1;
            --bg-gradient-end: #dce3ec;
            --text-primary: #1a1a1a;
            --text-secondary: rgba(0, 0, 0, 0.7);
            --text-tertiary: rgba(0, 0, 0, 0.5);
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(255, 255, 255, 0.8);
            --input-border: rgba(212, 175, 55, 0.5);
            --gold-primary: #b8941e;
            --gold-secondary: rgba(212, 175, 55, 0.25);
            --profit-color: #28a745;
            --loss-color: #dc3545;
            --shadow: rgba(0, 0, 0, 0.15);
            --item-bg: rgba(0, 0, 0, 0.04);
            --alert-item-bg: rgba(0, 0, 0, 0.03);
            --nav-bg: rgba(0, 0, 0, 0.06);
        }

        body.light-mode .stat-value,
        body.light-mode .price-value,
        body.light-mode .calculator-result-value {
            color: var(--text-primary) !important;
        }

        body.light-mode .stat-value.profit {
            color: var(--profit-color) !important;
        }

        body.light-mode .stat-value.loss {
            color: var(--loss-color) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            height: auto;
            color: var(--text-primary);
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            transition: background 0.3s ease;
        }

        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, var(--card-border) 50%, var(--card-bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 12px;
        }

        .skeleton-price {
            height: 40px;
            width: 80%;
            margin: 10px auto;
        }

        .skeleton-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
        }

        /* Pull to Refresh */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            opacity: 0;
            transition: opacity 0.2s ease-out;
            z-index: 5;
            will-change: opacity, top;
        }

        .pull-to-refresh.visible {
            opacity: 1;
        }

        .pull-to-refresh.refreshing .spinner-blade {
            animation: spinner-fade 1s infinite linear;
        }

        .container.pulling {
            transition: none;
        }

        .container.pull-release {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .spinner-blade {
            position: absolute;
            left: 44.5%;
            top: 0;
            width: 11%;
            height: 30%;
            background-color: var(--text-secondary);
            border-radius: 50px;
            transform-origin: 50% 100%;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .spinner-blade:nth-child(1) {
            transform: rotate(0deg) translateY(-65%);
        }

        .spinner-blade:nth-child(2) {
            transform: rotate(45deg) translateY(-65%);
        }

        .spinner-blade:nth-child(3) {
            transform: rotate(90deg) translateY(-65%);
        }

        .spinner-blade:nth-child(4) {
            transform: rotate(135deg) translateY(-65%);
        }

        .spinner-blade:nth-child(5) {
            transform: rotate(180deg) translateY(-65%);
        }

        .spinner-blade:nth-child(6) {
            transform: rotate(225deg) translateY(-65%);
        }

        .spinner-blade:nth-child(7) {
            transform: rotate(270deg) translateY(-65%);
        }

        .spinner-blade:nth-child(8) {
            transform: rotate(315deg) translateY(-65%);
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(1) {
            animation-delay: -0.875s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(2) {
            animation-delay: -0.750s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(3) {
            animation-delay: -0.625s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(4) {
            animation-delay: -0.500s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(5) {
            animation-delay: -0.375s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(6) {
            animation-delay: -0.250s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(7) {
            animation-delay: -0.125s;
        }

        .pull-to-refresh.refreshing .spinner-blade:nth-child(8) {
            animation-delay: 0s;
        }

        @keyframes spinner-fade {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0.1;
            }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px));
            min-height: 100vh;
            position: relative;
        }

        /* Login Page */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px var(--shadow);
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            font-size: 2.5em;
            color: var(--gold-primary);
            margin-bottom: 10px;
            font-family: 'B Titr', 'IRANYekanX', sans-serif;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 0.95em;
            font-family: 'IRANYekanX', sans-serif;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold-primary);
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--gold-primary);
            background: var(--card-bg);
        }

        .input-group input::placeholder {
            color: rgba(212, 175, 55, 0.5);
            font-weight: 600;
            opacity: 1;
        }

        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
            transition: all 0.3s ease;
        }

        .input-group select:focus {
            outline: none;
            border-color: var(--gold-primary);
            background: var(--card-bg);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0f2027;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Main App */
        .app-page {
            display: none;
        }

        .app-page.active {
            display: block;
        }

        .header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--card-border);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--gold-primary);
            object-fit: cover;
            flex-shrink: 0;
        }

        .user-avatar-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--gold-primary);
            background: var(--gold-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .header-info h2 {
            color: var(--gold-primary);
            margin-bottom: 5px;
        }

        .header-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .btn-logout {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-logout:hover {
            background: rgba(255, 59, 48, 0.3);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
        }

        .card-title {
            color: var(--gold-primary);
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: var(--item-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: var(--text-primary);
            font-size: 1.3em;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
        }

        .stat-value.profit {
            color: var(--profit-color);
        }

        .stat-value.loss {
            color: var(--loss-color);
        }

        /* Gold Price Display */
        .price-display {
            background: linear-gradient(135deg, var(--gold-secondary) 0%, rgba(244, 208, 63, 0.1) 100%);
            border: 2px solid var(--input-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .price-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .price-value {
            color: var(--text-primary);
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 10px;
            font-family: 'Nunito', sans-serif;
        }

        .price-change {
            font-size: 0.95em;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text-primary);
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
        }

        .price-change.up {
            background: rgba(52, 199, 89, 0.2);
            border: 1px solid #34c759;
            color: #34c759;
        }

        .price-change.down {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid #ff3b30;
            color: #ff3b30;
        }

        /* Portfolio Items */
        .portfolio-item {
            background: var(--item-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        .portfolio-item:hover {
            background: var(--input-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .portfolio-item-info {
            flex: 1;
        }

        .portfolio-item-info h4 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1em;
        }

        .portfolio-item-info p {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin: 4px 0;
        }

        .portfolio-item-value {
            text-align: left;
        }

        .portfolio-item-value .current {
            color: var(--gold-primary);
            font-weight: 800;
            font-size: 1em;
            font-family: 'Nunito', sans-serif;
        }

        .portfolio-item-value .profit {
            color: var(--profit-color);
            font-size: 0.85em;
            margin-top: 4px;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
        }

        .portfolio-item-value .loss {
            color: var(--loss-color);
            font-size: 0.85em;
            margin-top: 4px;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-delete:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: scale(1.05);
        }

        /* Alert Items */
        .alert-item {
            background: var(--alert-item-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .alert-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-type {
            color: #d4af37;
            font-weight: 600;
        }

        .alert-price {
            color: var(--text-primary);
            font-size: 1.1em;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
        }

        .alert-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .alert-status.active {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .alert-status.inactive {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        /* Calculator */
        .calculator {
            background: var(--item-bg);
            border-radius: 12px;
            padding: 20px;
        }

        .calculator-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .calculator-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
        }

        .calculator-input input:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        .calculator-result {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(244, 208, 63, 0.1) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .calculator-result-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .calculator-result-value {
            color: var(--gold-primary);
            font-size: 1.8em;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
        }

        /* Bottom Navigation */
        /* Theme Switcher */
        .theme-switcher {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--gold-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .theme-switcher:hover {
            transform: scale(1.1);
        }

        .theme-switcher:active {
            transform: scale(0.95);
        }

        .theme-switcher svg {
            width: 16px;
            height: 16px;
            transition: all 0.3s ease;
            position: absolute;
        }

        .theme-switcher .sun-icon {
            opacity: 0;
            transform: rotate(-90deg) scale(0);
        }

        .theme-switcher .moon-icon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
            color: var(--text-secondary);
        }

        body.light-mode .theme-switcher .sun-icon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        body.light-mode .theme-switcher .moon-icon {
            opacity: 0;
            transform: rotate(90deg) scale(0);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--card-border);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -2px 20px var(--shadow);
        }

        .nav-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px 8px;
            border-bottom: 1px solid var(--card-border);
            position: relative;
        }

        .datetime {
            display: flex;
            flex-direction: row;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
            direction: ltr;
            text-align: left;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
        }

        .nav-title {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--gold-primary);
            font-family: 'B Titr', 'IRANYekanX', sans-serif;
            direction: rtl;
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            pointer-events: none;
        }

        .nav-buttons-container {
            position: relative;
            display: flex;
            flex-direction: row-reverse;
            gap: 0;
            padding: 2px;
            margin: 8px 4px 0;
            background-color: var(--nav-bg);
            border-radius: 24px;
            height: 48px;
        }

        .nav-slider {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--gold-primary);
            border-radius: 22px;
            transition: none;
            height: calc(100% - 4px);
            top: 2px;
            z-index: 0;
            left: calc(33.33% + 2px);
            width: calc(33.33% - 1.33px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
        }

        .nav-button {
            flex: 1;
            padding: 10px 5px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            font-family: 'Nunito', 'IRANYekanX', sans-serif;
            position: relative;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-button.active {
            color: #ffffff;
            font-weight: 600;
        }

        body.light-mode .nav-button.active {
            color: #1a1a1a;
        }

        .nav-button:hover {
            color: var(--text-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #d4af37;
            font-size: 1.3em;
            font-weight: 600;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
                padding-bottom: max(220px, calc(150px + env(safe-area-inset-bottom)));
            }

            .login-card {
                padding: 30px 20px;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .price-value {
                font-size: 1.5em;
            }
        }

        /* Utilities */
        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* Calculator clear button */
        .calc-input-wrapper {
            position: relative;
            flex: 1;
        }

        .calc-input-wrapper input {
            width: 100%;
            padding-left: 40px;
        }

        .calc-clear-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-secondary);
            font-size: 1em;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .calc-clear-btn.visible {
            display: flex;
        }

        .calc-clear-btn:hover {
            background: rgba(255, 59, 48, 0.3);
            color: #ff3b30;
        }

        /* Tab slide animation */
        .tab-content {
            animation: none;
        }

        .tab-content.tab-enter {
            animation: tabSlideUp 0.3s ease-out;
        }

        @keyframes tabSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Data loading overlay */
        .data-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            transition: opacity 0.3s ease;
        }

        .data-loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-ring {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top: 3px solid #d4af37;
            border-right: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div
                style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 160px; height: 2px; background: linear-gradient(to right, transparent, rgba(156, 163, 175, 0.3), transparent);">
            </div>

            <div class="login-logo">
                <h1>Ø·Ù„Ø§ ÛŒØ§Ø±</h1>
                <p>Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø·Ù„Ø§</p>
            </div>

            <div id="autoLoginLoading" style="text-align: center; padding: 40px;">
                <div class="spinner"></div>
                <p
                    style="margin-top: 20px; color: rgba(255, 255, 255, 0.7); font-family: 'IRANYekanX', sans-serif; font-weight: 600;">
                    Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±...</p>
                <button id="autoLoginCancel" onclick="cancelAutoLogin()" class="btn btn-secondary"
                    style="display: none; margin-top: 20px; width: auto; padding: 10px 30px;">ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÛŒ</button>
            </div>
            <div id="loginForm" style="display: none;">
                <!-- How to get ID instruction -->
                <div
                    style="background: rgba(31, 41, 55, 0.5); padding: 16px; border-radius: 16px; border: 1px solid rgba(55, 65, 81, 0.5); text-align: center; margin-bottom: 20px; backdrop-filter: blur(4px);">
                    <p
                        style="color: rgba(156, 163, 175, 0.9); font-size: 0.75em; margin-bottom: 12px; line-height: 1.6;">
                        Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± Ø±Ø¨Ø§Øª ÙˆØ§Ø±Ø¯ Ùˆ Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯:</p>

                    <div style="background: rgba(17, 24, 39, 0.8); border: 1px solid rgb(75, 85, 99); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='rgba(34, 197, 94, 0.5)'"
                        onmouseout="this.style.borderColor='rgb(75, 85, 99)'" onclick="copyCommand()">
                        <code
                            style="color: rgb(252, 165, 165); font-family: 'Courier New', monospace; letter-spacing: 1.5px; font-weight: 700;">/whatismyid</code>
                        <span id="copyText"
                            style="color: rgb(107, 114, 128); font-size: 0.75em; transition: color 0.3s;">Ú©Ù¾ÛŒ</span>
                    </div>

                    <a href="https://t.me/GoldYarRoBot" target="_blank" rel="noreferrer"
                        style="color: rgb(96, 165, 250); font-size: 0.75em; margin-top: 12px; display: block; text-decoration: none; transition: color 0.3s;"
                        onmouseover="this.style.color='rgb(147, 197, 253)'"
                        onmouseout="this.style.color='rgb(96, 165, 250)'">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… â†’</a>
                </div>

                <div class="input-group">
                    <input type="tel" id="userIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ (User ID)"
                        style="text-align: center; direction: ltr; letter-spacing: 2px; font-family: 'Courier New', monospace; font-size: 1.1em;">
                </div>
                <button class="btn btn-primary" onclick="requestCode()">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
            </div>

            <div id="verifyForm" style="display: none;">
                <div class="input-group">
                    <label for="codeInput">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ 10 Ø±Ù‚Ù…ÛŒ</label>
                    <input type="text" id="codeInput" placeholder="Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                        style="text-align: center; direction: ltr; letter-spacing: 2px; font-family: 'Courier New', monospace;">
                </div>
                <button class="btn btn-primary" onclick="verifyCode()">ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-secondary mt-20" onclick="backToLogin()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appPage" class="app-page">
        <div class="container">
            <div class="header">
                <div class="header-info">
                    <div id="userAvatar" class="user-avatar-placeholder">ğŸ‘¤</div>
                    <div>
                        <h2 id="userName">Ú©Ø§Ø±Ø¨Ø±</h2>
                        <p id="userId"></p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <!-- Pull to Refresh Indicator -->
            <div class="pull-to-refresh" id="pullToRefreshIndicator">
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
                <div class="spinner-blade"></div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <!-- Live Gold Price -->
                <div class="card" id="priceCard">
                    <div class="card-title">ğŸ’° Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø·Ù„Ø§</div>
                    <div class="price-display">
                        <div class="price-label">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù… Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø±</div>
                        <div class="price-value" id="currentPrice">
                            <div class="skeleton skeleton-price"></div>
                        </div>
                        <div class="price-change up" id="priceChange" style="direction: ltr;">
                            <span id="priceChangeText">--</span>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Summary -->
                <div class="card">
                    <div class="card-title">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø¯Ø§Ø±Ø§ÛŒÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
                    <div style="display: flex; gap: 12px; margin-top: 15px;">
                        <div class="stat-item" style="flex: 1;">
                            <div class="stat-label">ğŸ’ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</div>
                            <div class="stat-value" id="currentValue" style="font-size: 1.1em;">0</div>
                        </div>
                        <div class="stat-item" style="flex: 1;">
                            <div class="stat-label">ğŸ“ˆ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
                            <div class="stat-value profit" id="profitLoss" style="font-size: 1.1em;">0</div>
                            <div id="profitPercent"
                                style="font-size: 0.8em; margin-top: 4px; direction: ltr; font-family: 'Nunito', sans-serif; font-weight: 800;">
                                0%</div>
                        </div>
                    </div>
                </div>

                <!-- Gold Calculator -->
                <div class="card">
                    <div class="card-title">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ù‚ÛŒÙ…Øª Ø·Ù„Ø§</div>
                    <div class="calculator">
                        <div class="calculator-input">
                            <div class="calc-input-wrapper">
                                <input type="number" id="calcWeight" placeholder="ÙˆØ²Ù† (Ú¯Ø±Ù…)" step="0.01"
                                    oninput="onCalcInput()">
                                <button id="calcClearBtn" class="calc-clear-btn" onclick="clearCalcWeight()">âœ•</button>
                            </div>
                        </div>
                        <div class="calculator-result">
                            <div class="calculator-result-label">Ø§Ø±Ø²Ø´ ØªÙ‚Ø±ÛŒØ¨ÛŒ</div>
                            <div class="calculator-result-value" id="calcResult">0 ØªÙˆÙ…Ø§Ù†</div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <div class="card-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ø§Ø¹Ù„Ø§Ù†</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                        <div>
                            <div style="color: var(--text-primary); margin-bottom: 5px;">Ø²Ù…Ø§Ù† Ø§Ø¹Ù„Ø§Ù† Ù‚ÛŒÙ…Øª</div>
                            <div style="color: var(--text-tertiary); font-size: 0.85em;" id="notificationTime">00:40
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px;"
                            onclick="openChangeTimeModal()">ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª</button>
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolioTab" class="tab-content hidden">
                <!-- Portfolio Summary Card -->
                <div class="card">
                    <div class="card-title">ğŸ’° Ø³Ø¨Ø¯ Ø·Ù„Ø§ÛŒ Ø´Ù…Ø§ (ØªÙˆÙ…Ø§Ù†)</div>

                    <!-- Ú©Ù„ Ø·Ù„Ø§ - Ø§ÙˆÙ„ -->
                    <div class="stat-item" style="margin-top: 15px;">
                        <div class="stat-label">âš–ï¸ Ú©Ù„ Ø·Ù„Ø§</div>
                        <div class="stat-value" id="totalGoldWeight">0 Ú¯Ø±Ù…</div>
                    </div>

                    <!-- Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ùˆ Ø³Ø±Ù…Ø§ÛŒÙ‡ - Ú©Ù†Ø§Ø± Ù‡Ù… -->
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <div class="stat-item" style="flex: 1;">
                            <div class="stat-label">ğŸ’ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</div>
                            <div class="stat-value" id="totalPortfolioValue">0</div>
                        </div>
                        <div class="stat-item" style="flex: 1;">
                            <div class="stat-label">ğŸ’° Ø³Ø±Ù…Ø§ÛŒÙ‡</div>
                            <div class="stat-value" id="totalPortfolioInvestment">0</div>
                        </div>
                    </div>

                    <!-- Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ùˆ Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ± -->
                    <div class="stat-item" style="margin-top: 12px;">
                        <div class="stat-label">ğŸ“ˆ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
                        <div class="stat-value profit" id="totalPortfolioProfit">0</div>
                        <div id="totalPortfolioProfitPercent"
                            style="font-size: 0.8em; margin-top: 4px; direction: ltr; font-family: 'Nunito', sans-serif; font-weight: 800;">
                            0%
                        </div>
                    </div>
                </div>

                <!-- Portfolio Items -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ’¼ Ù„ÛŒØ³Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</span>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px; font-size: 0.9em;"
                            onclick="openAddPortfolioModal()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                    <div id="portfolioList"></div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab" class="tab-content hidden">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ù‚ÛŒÙ…Øª</span>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px; font-size: 0.9em;"
                            onclick="openAddAlertModal()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                    <div id="alertsList"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottom-nav">
            <div class="nav-top-row">
                <div class="datetime">
                    <span id="live-date">1404/11/21</span>
                    <span id="live-time">19:39</span>
                </div>
                <div class="nav-title">Ø·Ù„Ø§ ÛŒØ§Ø±</div>
                <button class="theme-switcher" onclick="toggleTheme()" aria-label="Toggle theme">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
            <div class="nav-buttons-container" id="bottom-nav-buttons">
                <div class="nav-slider" id="navSlider"></div>
                <button class="nav-button" data-target="alerts" onclick="switchTab('alerts')">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</button>
                <button class="nav-button active" data-target="dashboard" onclick="switchTab('dashboard')">ğŸ 
                    Ø®Ø§Ù†Ù‡</button>
                <button class="nav-button" data-target="portfolio" onclick="switchTab('portfolio')">ğŸ’¼ Ø¯Ø§Ø±Ø§ÛŒÛŒ</button>
            </div>
        </div>
    </div>

    <!-- Add Portfolio Modal -->
    <div id="addPortfolioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
                <button class="btn-close" onclick="closeAddPortfolioModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>ÙˆØ²Ù† (Ú¯Ø±Ù…)</label>
                    <input type="number" id="newWeight" placeholder="Ù…Ø«Ø§Ù„: 5.5" step="0.01">
                </div>

                <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª -->
                <div class="input-group">
                    <label>Ù†ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª</label>
                    <select id="priceInputType" onchange="togglePriceInput()">
                        <option value="per_gram">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù…</option>
                        <option value="total">Ù‚ÛŒÙ…Øª Ú©Ù„ Ø®Ø±ÛŒØ¯</option>
                    </select>
                </div>

                <div class="input-group" id="pricePerGramGroup">
                    <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ù‡Ø± Ú¯Ø±Ù… (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="newPricePerGram" placeholder="Ù…Ø«Ø§Ù„: 5,000,000"
                        oninput="formatPriceInput(this)">
                </div>

                <div class="input-group" id="totalPriceGroup" style="display: none;">
                    <label>Ù‚ÛŒÙ…Øª Ú©Ù„ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="newTotalPrice" placeholder="Ù…Ø«Ø§Ù„: 27,500,000"
                        oninput="formatPriceInput(this)">
                </div>

                <div class="input-group">
                    <label>ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯</label>
                    <input type="text" id="newDate" placeholder="Ù…Ø«Ø§Ù„: 1403/11/20">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addPortfolioItem()">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div id="addAlertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª</div>
                <button class="btn-close" onclick="closeAddAlertModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ø·Ù„Ø§</label>
                    <select id="alertGoldType">
                        <option value="18_750">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (750)</option>
                        <option value="18_740">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (740)</option>
                        <option value="24">Ø·Ù„Ø§ÛŒ 24 Ø¹ÛŒØ§Ø±</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ù‡Ø´Ø¯Ø§Ø±</label>
                    <select id="alertType">
                        <option value="above">Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø²</option>
                        <option value="below">Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø²</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ù‚ÛŒÙ…Øª Ù‡Ø¯Ù (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="alertTargetPrice" placeholder="Ù…Ø«Ø§Ù„: 5,200,000"
                        oninput="formatPriceInput(this)">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addAlert()">Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±</button>
        </div>
    </div>

    <!-- Change Time Modal -->
    <div id="changeTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª Ø§Ø¹Ù„Ø§Ù†</div>
                <button class="btn-close" onclick="closeChangeTimeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Ø³Ø§Ø¹Øª (24 Ø³Ø§Ø¹ØªÙ‡)</label>
                    <input type="time" id="newNotificationTime">
                </div>
            </div>
            <button class="btn btn-primary" onclick="changeNotificationTime()">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://page-teleg.goldyarprice.workers.dev';
        let userData = null;
        let currentGoldPrice = 0;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¨ Theme Management
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-mode');

            if (body.classList.contains('light-mode')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ• Live Date & Time
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateDateTime() {
            const now = new Date();

            // Persian date with English digits
            const persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
            const toEnDigits = str => str.replace(/[Û°-Û¹]/g, d => persianDigits.indexOf(d));

            const persianDate = toEnDigits(new Intl.DateTimeFormat('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(now));

            // Time with English digits
            const time = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            document.getElementById('live-date').textContent = persianDate;
            document.getElementById('live-time').textContent = time;
        }

        // Update every second
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¯ Navigation Slider
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateNavSlider(targetTab) {
            const buttons = document.querySelectorAll('#bottom-nav-buttons .nav-button');
            const slider = document.getElementById('navSlider');
            const container = document.getElementById('bottom-nav-buttons');

            if (!slider || !container || buttons.length === 0) return;

            let activeIndex = 0;

            buttons.forEach((btn, index) => {
                if (btn.dataset.target === targetTab) {
                    activeIndex = index;
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Calculate slider width and position
            const containerWidth = container.offsetWidth;
            const padding = 2; // padding from container
            const buttonWidth = (containerWidth - (padding * 2)) / buttons.length;

            slider.style.width = `${buttonWidth}px`;

            // Position slider directly at active button index
            const leftPosition = padding + (activeIndex * buttonWidth);
            slider.style.left = `${leftPosition}px`;

            // Enable transition after first positioning (instant on load, animated after)
            if (!slider._transitionEnabled) {
                requestAnimationFrame(() => {
                    slider.style.transition = 'left 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    slider._transitionEnabled = true;
                });
            }
        }

        // Slider will be initialized when appPage becomes active (see loadUserData)

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”„ Pull to Refresh
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let pullStartY = 0;
        let pullDistance = 0;
        let isPulling = false;
        let isRefreshing = false;
        const pullThreshold = 90;
        const REFRESH_AREA_HEIGHT = 70;
        let rafId = null;

        function initPullToRefresh() {
            const container = document.querySelector('.container');
            const indicator = document.getElementById('pullToRefreshIndicator');
            const blades = indicator.querySelectorAll('.spinner-blade');

            container.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                    container.classList.add('pulling');
                    container.classList.remove('pull-release');
                }
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;

                const touchY = e.touches[0].clientY;
                pullDistance = touchY - pullStartY;

                if (pullDistance > 0 && window.scrollY === 0) {
                    e.preventDefault();

                    if (rafId) cancelAnimationFrame(rafId);
                    rafId = requestAnimationFrame(() => {
                        const translateY = Math.pow(pullDistance, 0.85);
                        container.style.transform = `translateY(${translateY}px)`;

                        // Center spinner in the gap
                        indicator.style.top = `${translateY / 2 - 14}px`;
                        indicator.classList.add('visible');
                        const pullRatio = Math.min(1, pullDistance / pullThreshold);
                        const bladesToShow = Math.floor(pullRatio * 8);
                        blades.forEach((blade, i) => {
                            blade.style.opacity = i < bladesToShow ? 1 : 0;
                        });
                    });
                }
            }, { passive: false });

            container.addEventListener('touchend', async (e) => {
                if (!isPulling || isRefreshing) return;
                isPulling = false;
                if (rafId) cancelAnimationFrame(rafId);

                container.classList.remove('pulling');
                container.classList.add('pull-release');

                if (pullDistance >= pullThreshold) {
                    // Start refresh - hold content down
                    isRefreshing = true;
                    container.style.transform = `translateY(${REFRESH_AREA_HEIGHT}px)`;
                    indicator.style.top = `${REFRESH_AREA_HEIGHT / 2 - 14}px`;
                    indicator.classList.add('refreshing');
                    blades.forEach(blade => blade.style.opacity = 1);

                    await refreshData();

                    // End refresh - slide back
                    setTimeout(() => {
                        container.style.transform = 'translateY(0)';
                        indicator.classList.remove('refreshing', 'visible');
                        indicator.style.top = '0';
                        blades.forEach(blade => blade.style.opacity = 0);
                        isRefreshing = false;
                    }, 500);
                } else {
                    // Not enough pull - reset
                    container.style.transform = 'translateY(0)';
                    indicator.classList.remove('visible');
                    indicator.style.top = '0';
                    blades.forEach(blade => blade.style.opacity = 0);
                }

                pullDistance = 0;
            });
        }

        async function refreshData() {
            try {
                // Skip loading overlay during pull-to-refresh (spinner already visible)
                window._skipDataLoading = true;

                // Navigate to dashboard (main page) on refresh
                switchTab('dashboard');
                window.scrollTo({ top: 0, behavior: 'instant' });

                // Run both in parallel - if one fails, the other still completes
                const results = await Promise.allSettled([
                    loadCurrentGoldPrice(),
                    loadUserData()
                ]);

                results.forEach((result, i) => {
                    if (result.status === 'rejected') {
                        console.error(`âŒ Refresh task ${i} failed:`, result.reason);
                    }
                });

                console.log('âœ… Data refreshed');
            } catch (error) {
                console.error('âŒ Failed to refresh data:', error);
            } finally {
                window._skipDataLoading = false;
            }
        }

        // Initialize
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        // Initialize theme and pull to refresh
        initTheme();
        initPullToRefresh();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ‘† Swipe Navigation between tabs
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (function initSwipeNavigation() {
            // Visual order (RTL): Ø¯Ø§Ø±Ø§ÛŒÛŒ (right) â†’ Ø®Ø§Ù†Ù‡ (center) â†’ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ (left)
            const tabOrder = ['portfolio', 'dashboard', 'alerts'];
            let swipeStartX = 0;
            let swipeStartY = 0;
            let isSwiping = false;
            const swipeThreshold = 60;

            function getCurrentTab() {
                const activeBtn = document.querySelector('.nav-button.active');
                return activeBtn ? activeBtn.dataset.target : 'dashboard';
            }

            const container = document.querySelector('.container');
            if (!container) return;

            container.addEventListener('touchstart', (e) => {
                // Don't interfere with modals or inputs
                if (e.target.closest('.modal') || e.target.closest('input') || e.target.closest('textarea')) return;
                swipeStartX = e.touches[0].clientX;
                swipeStartY = e.touches[0].clientY;
                isSwiping = true;
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isSwiping) return;
                isSwiping = false;

                const swipeEndX = e.changedTouches[0].clientX;
                const swipeEndY = e.changedTouches[0].clientY;
                const diffX = swipeEndX - swipeStartX;
                const diffY = swipeEndY - swipeStartY;

                // Only horizontal swipe (ignore vertical scrolling)
                if (Math.abs(diffX) < swipeThreshold || Math.abs(diffY) > Math.abs(diffX)) return;

                const currentTab = getCurrentTab();
                const currentIndex = tabOrder.indexOf(currentTab);
                if (currentIndex === -1) return;

                let newIndex;
                if (diffX > 0) {
                    // Swipe right â†’ go to tab on the right (lower index in RTL visual)
                    newIndex = currentIndex - 1;
                } else {
                    // Swipe left â†’ go to tab on the left (higher index in RTL visual)
                    newIndex = currentIndex + 1;
                }

                if (newIndex >= 0 && newIndex < tabOrder.length) {
                    switchTab(tabOrder[newIndex]);
                }
            }, { passive: true });
        })();

        // Auto-login with Telegram data
        async function autoLogin() {
            try {
                const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;

                if (tgUser && tgUser.id) {
                    console.log('ğŸ” Auto-login attempt with Telegram user:', tgUser.id);

                    const response = await fetch(`${API_BASE}/api/auto-login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: tgUser.id,
                            firstName: tgUser.first_name || '',
                            lastName: tgUser.last_name || '',
                            username: tgUser.username || ''
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.token) {
                        console.log('âœ… Auto-login successful');
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('authUserId', String(tgUser.id));
                        return true;
                    }
                } else {
                    console.log('âš ï¸ No Telegram user data available');
                }
            } catch (error) {
                console.error('âŒ Auto-login failed:', error);
            }
            return false;
        }

        // Cancel auto-login and show manual login form
        function cancelAutoLogin() {
            const autoLoginLoading = document.getElementById('autoLoginLoading');
            const loginForm = document.getElementById('loginForm');
            if (autoLoginLoading) autoLoginLoading.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
        }

        // Show manual login after auto-login fails
        function showManualLogin() {
            const autoLoginLoading = document.getElementById('autoLoginLoading');
            const loginForm = document.getElementById('loginForm');
            if (autoLoginLoading) autoLoginLoading.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
        }

        // Main initialization
        (async function init() {
            const autoLoginLoading = document.getElementById('autoLoginLoading');
            const loginForm = document.getElementById('loginForm');
            const existingToken = localStorage.getItem('authToken');
            const storedUserId = localStorage.getItem('authUserId');
            const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;

            // Check if Telegram user matches stored user (multi-account support)
            if (existingToken && tgUser && tgUser.id && storedUserId) {
                if (String(tgUser.id) !== String(storedUserId)) {
                    // Different account detected - clear old session and re-login
                    console.log('ğŸ”„ Different Telegram account detected:', tgUser.id, 'vs stored:', storedUserId);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUserId');
                    // Fall through to auto-login below
                } else {
                    // Same account - use existing token
                    console.log('âœ… Same account, using existing token');
                    if (autoLoginLoading) autoLoginLoading.style.display = 'none';
                    loadUserData();
                    return;
                }
            } else if (existingToken && !tgUser) {
                // No Telegram data (opened outside Telegram?) - use existing token
                console.log('â„¹ï¸ No Telegram data, using existing token');
                if (autoLoginLoading) autoLoginLoading.style.display = 'none';
                loadUserData();
                return;
            } else if (existingToken && tgUser && !storedUserId) {
                // Has token but no stored userId (old session) - re-login to be safe
                console.log('ğŸ”„ Old session without userId, re-authenticating...');
                localStorage.removeItem('authToken');
                // Fall through to auto-login below
            }

            // No valid token - try auto-login
            // Show cancel button after 5 seconds
            const cancelTimer = setTimeout(() => {
                const cancelBtn = document.getElementById('autoLoginCancel');
                if (cancelBtn) cancelBtn.style.display = 'inline-block';
            }, 5000);

            const success = await autoLogin();
            clearTimeout(cancelTimer);

            if (success) {
                // Auto-login succeeded - hide loading and load app
                if (autoLoginLoading) autoLoginLoading.style.display = 'none';
                loadUserData();
            } else {
                // Auto-login failed - show manual login
                console.log('ğŸ“ Manual login required');
                showManualLogin();
            }
        })();

        // Copy /whatismyid command
        function copyCommand() {
            const command = '/whatismyid';
            navigator.clipboard.writeText(command).then(() => {
                const copyTextEl = document.getElementById('copyText');
                copyTextEl.textContent = 'Ú©Ù¾ÛŒ Ø´Ø¯ âœ“';
                copyTextEl.style.color = 'rgb(34, 197, 94)';

                setTimeout(() => {
                    copyTextEl.textContent = 'Ú©Ù¾ÛŒ';
                    copyTextEl.style.color = 'rgb(107, 114, 128)';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Request verification code
        async function requestCode() {
            const userId = document.getElementById('userIdInput').value.trim();

            if (!userId) {
                alert('Ù„Ø·ÙØ§ Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/request-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: parseInt(userId) })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('verifyForm').style.display = 'block';
                    alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                } else {
                    alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Verify code and login
        async function verifyCode() {
            const userId = document.getElementById('userIdInput').value.trim();
            const code = document.getElementById('codeInput').value.trim();

            if (!code) {
                alert('Ù„Ø·ÙØ§ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/verify-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        code: code
                    })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('authUserId', userId);
                    loadUserData();
                } else {
                    alert(data.message || 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ú©Ø¯');
            }
        }

        // Show/hide data loading
        function showDataLoading() {
            // Skip if pull-to-refresh is active
            if (window._skipDataLoading) return;
            // Only show if not already visible
            if (document.getElementById('dataLoadingOverlay')) return;
            const overlay = document.createElement('div');
            overlay.id = 'dataLoadingOverlay';
            overlay.className = 'data-loading-overlay';
            overlay.innerHTML = '<div class="loading-ring"></div><p style="margin-top: 15px; color: var(--gold-primary); font-family: \'B Titr\', sans-serif; font-size: 1.3em;">Ø·Ù„Ø§ ÛŒØ§Ø±</p><p style="margin-top: 10px; color: rgba(255,255,255,0.7); font-family: IRANYekanX, sans-serif; font-weight: 600;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>';
            document.body.appendChild(overlay);
        }

        function hideDataLoading() {
            const overlay = document.getElementById('dataLoadingOverlay');
            if (overlay) {
                overlay.classList.add('fade-out');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // Load user data
        async function loadUserData() {
            const token = localStorage.getItem('authToken');
            showDataLoading();

            try {
                const response = await fetch(`${API_BASE}/api/user?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    cache: 'no-store'
                });

                const data = await response.json();

                if (data.success) {
                    userData = data;

                    // Ù„Ø§Ú¯ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø±ÛŒØ§ÙØªÛŒ
                    console.log('ğŸ“¦ User data received:', {
                        portfolio: {
                            totalInvestment: data.portfolio.totalInvestment,
                            currentValue: data.portfolio.currentValue,
                            profit: data.portfolio.profit,
                            profitPercent: data.portfolio.profitPercent,
                            itemsCount: data.portfolio.items ? data.portfolio.items.length : 0
                        }
                    });

                    // Store userId for multi-account detection
                    if (data.user.user_id) {
                        localStorage.setItem('authUserId', String(data.user.user_id));
                    }

                    // Update UI
                    document.getElementById('userName').textContent = data.user.first_name || 'Ú©Ø§Ø±Ø¨Ø±';
                    document.getElementById('userId').textContent = `Ø´Ù†Ø§Ø³Ù‡: ${data.user.user_id}`;

                    // Set profile photo from Telegram
                    const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
                    const avatarEl = document.getElementById('userAvatar');
                    if (tgUser && tgUser.photo_url) {
                        avatarEl.outerHTML = `<img id="userAvatar" class="user-avatar" src="${tgUser.photo_url}" alt="" onerror="this.outerHTML='<div id=userAvatar class=user-avatar-placeholder>ğŸ‘¤</div>'">`;
                    }
                    document.getElementById('notificationTime').textContent = data.user.notification_time || '00:40';

                    // Calculate total gold weight
                    let totalWeight = 0;
                    if (data.portfolio.items && data.portfolio.items.length > 0) {
                        totalWeight = data.portfolio.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                    }

                    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø±ÛŒØ§ÙØªÛŒ
                    const totalInvestment = parseFloat(data.portfolio.totalInvestment) || 0;
                    const currentValue = parseFloat(data.portfolio.currentValue) || 0;
                    const profit = parseFloat(data.portfolio.profit) || 0;
                    const profitPercent = parseFloat(data.portfolio.profitPercent) || 0;

                    // Portfolio summary (Dashboard)
                    document.getElementById('currentValue').textContent = formatPrice(currentValue);

                    const profitLossEl = document.getElementById('profitLoss');
                    const profitSign = profit >= 0 ? '+' : '-';
                    profitLossEl.textContent = formatPrice(Math.abs(profit)) + profitSign;
                    if (profit === 0) {
                        profitLossEl.className = 'stat-value';
                    } else {
                        profitLossEl.className = 'stat-value ' + (profit >= 0 ? 'profit' : 'loss');
                    }

                    const profitPercentEl = document.getElementById('profitPercent');
                    const profitPercentSign = profitPercent >= 0 ? '+' : '';
                    profitPercentEl.textContent = profitPercentSign + profitPercent.toFixed(2) + '%';
                    profitPercentEl.style.color = 'var(--text-secondary)';

                    // Portfolio Tab Summary - Ù…Ø·Ø§Ø¨Ù‚ Ø±Ø¨Ø§Øª
                    document.getElementById('totalPortfolioInvestment').textContent = formatPrice(totalInvestment);
                    document.getElementById('totalGoldWeight').textContent = totalWeight.toFixed(2) + ' Ú¯Ø±Ù…';
                    document.getElementById('totalPortfolioValue').textContent = formatPrice(currentValue);

                    const totalProfitEl = document.getElementById('totalPortfolioProfit');
                    totalProfitEl.textContent = formatPrice(Math.abs(profit)) + (profit >= 0 ? '+' : '-');
                    if (profit === 0) {
                        totalProfitEl.className = 'stat-value';
                    } else {
                        totalProfitEl.className = 'stat-value ' + (profit >= 0 ? 'profit' : 'loss');
                    }

                    const totalProfitPercentEl = document.getElementById('totalPortfolioProfitPercent');
                    const totalProfitPercentSign = profitPercent >= 0 ? '+' : '';
                    totalProfitPercentEl.textContent = totalProfitPercentSign + profitPercent.toFixed(2) + '%';
                    totalProfitPercentEl.style.color = 'var(--text-secondary)';

                    // Load portfolio items
                    loadPortfolioItems(data.portfolio.items);

                    // Load alerts
                    loadAlerts(data.alerts);

                    // Show app page
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appPage').classList.add('active');

                    // Initialize slider on dashboard only on first load
                    if (!window._sliderInitialized) {
                        requestAnimationFrame(() => {
                            updateNavSlider('dashboard');
                        });
                        window._sliderInitialized = true;
                    }

                    // Hide loading overlay
                    hideDataLoading();

                    // Load current gold price
                    loadCurrentGoldPrice();
                } else {
                    hideDataLoading();
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUserId');
                    alert('Ù†Ø´Ø³Øª Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                }
            } catch (error) {
                hideDataLoading();
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
            }
        }

        // Load current gold price
        async function loadCurrentGoldPrice() {
            try {
                const response = await fetch(`${API_BASE}/api/gold-price?t=${Date.now()}`, {
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.price) {
                    currentGoldPrice = data.price;
                    const priceEl = document.getElementById('currentPrice');
                    priceEl.innerHTML = formatPrice(currentGoldPrice) + ' ØªÙˆÙ…Ø§Ù†';

                    const changeEl = document.getElementById('priceChange');
                    const changeTextEl = document.getElementById('priceChangeText');

                    if (data.changePercent === 0) {
                        changeEl.className = 'price-change';
                        changeTextEl.textContent = '0.00%';
                    } else if (data.changePercent > 0) {
                        changeEl.className = 'price-change up';
                        changeTextEl.textContent = `â–² ${data.changePercent.toFixed(2)}%`;
                    } else {
                        changeEl.className = 'price-change down';
                        changeTextEl.textContent = `â–¼ ${Math.abs(data.changePercent).toFixed(2)}%`;
                    }

                    // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ø¨Ø¹ Ù‚ÛŒÙ…Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                    console.log('ğŸ’° Price source:', data.source || 'unknown');

                    // Update portfolio values with current price
                    if (userData && userData.portfolio && userData.portfolio.items) {
                        recalculatePortfolioValues();
                    }
                } else {
                    throw new Error('Invalid API response');
                }
            } catch (error) {
                console.error('âŒ Failed to fetch gold price from API:', error);

                // Fallback: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ±ØªÙÙˆÙ„ÛŒÙˆ
                if (userData && userData.portfolio && userData.portfolio.items && userData.portfolio.items.length > 0) {
                    console.log('ğŸ“Š Using portfolio data as fallback');

                    const totalValue = userData.portfolio.items.reduce((sum, item) => sum + item.current_value, 0);
                    const totalWeight = userData.portfolio.items.reduce((sum, item) => sum + item.weight, 0);

                    if (totalWeight > 0) {
                        currentGoldPrice = Math.round(totalValue / totalWeight);
                        const priceEl = document.getElementById('currentPrice');
                        priceEl.innerHTML = formatPrice(currentGoldPrice) + ' ØªÙˆÙ…Ø§Ù†';

                        const changeEl = document.getElementById('priceChange');
                        const changeTextEl = document.getElementById('priceChangeText');
                        const changePercent = userData.portfolio.profitPercent || 0;

                        if (changePercent === 0) {
                            changeEl.className = 'price-change';
                            changeTextEl.textContent = '0.00%';
                        } else if (changePercent > 0) {
                            changeEl.className = 'price-change up';
                            changeTextEl.textContent = `â–² ${changePercent.toFixed(2)}%`;
                        } else {
                            changeEl.className = 'price-change down';
                            changeTextEl.textContent = `â–¼ ${Math.abs(changePercent).toFixed(2)}%`;
                        }

                        // Update portfolio display
                        recalculatePortfolioValues();
                    } else {
                        document.getElementById('currentPrice').textContent = 'Ù‚ÛŒÙ…Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
                    }
                } else {
                    document.getElementById('currentPrice').textContent = 'Ù‚ÛŒÙ…Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
                    document.getElementById('priceChangeText').textContent = '--';
                }
            }
        }

        // Recalculate portfolio values - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ API
        function recalculatePortfolioValues() {
            // Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ API ØªÙ…Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ
            // ÙÙ‚Ø· Ù†ÛŒØ§Ø² Ø§Ø³Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒÙ…
            if (!userData || !userData.portfolio) return;

            // Update portfolio items display Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø§Ø² API
            loadPortfolioItems(userData.portfolio.items);
        }

        // Load portfolio items
        function loadPortfolioItems(items) {
            const container = document.getElementById('portfolioList');

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p></div>';
                return;
            }

            container.innerHTML = items.map((item, index) => {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ù‡ Ø§Ø² API Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯
                const weight = parseFloat(item.weight) || 0;
                const pricePerGram = parseFloat(item.purchase_price) || 0; // ÙÛŒÙ„Ø¯ ØµØ­ÛŒØ­ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                const totalPaid = parseFloat(item.total_paid) || 0; // ÙÛŒÙ„Ø¯ ØµØ­ÛŒØ­ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³

                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø§Ø² API
                const itemCurrentValue = parseFloat(item.currentValue) || 0;
                const profit = parseFloat(item.profit) || 0;
                const profitPercent = parseFloat(item.profitPercent) || 0;

                const profitClass = profit === 0 ? '' : (profit >= 0 ? 'profit' : 'loss');
                const profitSign = profit >= 0 ? '+' : '-';
                const borderColor = profit === 0 ? 'rgba(255, 255, 255, 0.3)' : (profit >= 0 ? '#34c759' : '#ff3b30');

                return `
                    <div class="portfolio-item" style="border-right: 3px solid ${borderColor};">
                        <div class="portfolio-item-info">
                            <h4 style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: var(--gold-secondary); padding: 3px 10px; border-radius: 8px; font-size: clamp(0.85em, 3.8vw, 1.05em); white-space: nowrap;">${weight.toFixed(2)} Ú¯Ø±Ù…</span>
                                <span style="font-size: 0.85em; color: var(--text-secondary);">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø±</span>
                            </h4>
                            <p style="margin-top: 8px;">ğŸ’µ Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (Ù‡Ø± Ú¯Ø±Ù…): ${formatPrice(pricePerGram)} ØªÙˆÙ…Ø§Ù†</p>
                            <p style="margin-top: 4px;">ğŸ›’ Ù…Ø¨Ù„Øº Ú©Ù„ Ø®Ø±ÛŒØ¯: ${formatPrice(totalPaid)} ØªÙˆÙ…Ø§Ù†</p>
                            <p style="font-size: 0.8em; color: var(--text-tertiary); margin-top: 4px; font-family: 'Nunito', sans-serif;">ğŸ“… ${item.purchase_date || 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                            <div class="portfolio-item-value" style="text-align: left;">
                                <div class="current" style="font-size: 1.1em;">${formatPrice(itemCurrentValue)} ØªÙˆÙ…Ø§Ù†</div>
                                <div class="${profitClass}" style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                                    <span style="font-size: 0.85em; direction: ltr; unicode-bidi: embed; font-family: 'Nunito', sans-serif; font-weight: 800;">(${profitSign}${Math.abs(profitPercent).toFixed(2)}%)</span>
                                    <span style="direction: ltr; unicode-bidi: embed; font-family: 'Nunito', sans-serif; font-weight: 800;">${profitSign}${formatPrice(Math.abs(profit))}</span>
                                </div>
                            </div>
                            <button class="btn-delete" onclick="deletePortfolioItem(${item.id})" style="font-size: 0.8em; padding: 6px 12px;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load alerts
        function loadAlerts(alerts) {
            const container = document.getElementById('alertsList');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”•</div><p>Ù‡Ø´Ø¯Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p></div>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const statusClass = alert.is_triggered ? 'inactive' : 'active';
                const statusText = alert.is_triggered ? 'ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡' : 'ÙØ¹Ø§Ù„';
                const typeText = alert.alert_type === 'above' ? 'Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø²' : 'Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø²';

                // ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… Ø·Ù„Ø§
                let goldName = 'Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (750)';
                if (alert.gold_type === '24') {
                    goldName = 'Ø·Ù„Ø§ÛŒ 24 Ø¹ÛŒØ§Ø±';
                } else if (alert.purity === '740') {
                    goldName = 'Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (740)';
                }

                // ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® - Ø§Ú¯Ø± null Ø¨Ø§Ø´Ø¯ "ØªØ§Ø²Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡" Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                const createdDate = alert.created_at ? gregorianToJalali(alert.created_at) : 'ØªØ§Ø²Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡';

                return `
                    <div class="alert-item">
                        <div class="alert-item-header">
                            <div>
                                <div class="alert-type">${goldName}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85em; margin: 4px 0;">${typeText}</div>
                                <div class="alert-price">${formatPrice(alert.target_price)} ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="alert-status ${statusClass}">${statusText}</div>
                                <button class="btn-delete" onclick="deleteAlert(${alert.id})" style="padding: 4px 8px; font-size: 0.75em;">Ø­Ø°Ù</button>
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">
                            ğŸ“… ${createdDate}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle price input type
        function togglePriceInput() {
            const type = document.getElementById('priceInputType').value;
            const perGramGroup = document.getElementById('pricePerGramGroup');
            const totalGroup = document.getElementById('totalPriceGroup');

            if (type === 'per_gram') {
                perGramGroup.style.display = 'block';
                totalGroup.style.display = 'none';
            } else {
                perGramGroup.style.display = 'none';
                totalGroup.style.display = 'block';
            }
        }

        // Calculator input handler
        function onCalcInput() {
            const input = document.getElementById('calcWeight');
            const clearBtn = document.getElementById('calcClearBtn');
            if (input.value) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
            calculateGoldPrice();
        }

        // Clear calculator
        function clearCalcWeight() {
            document.getElementById('calcWeight').value = '';
            document.getElementById('calcClearBtn').classList.remove('visible');
            document.getElementById('calcResult').textContent = '0 ØªÙˆÙ…Ø§Ù†';
        }

        // Calculate gold price
        function calculateGoldPrice() {
            const weight = parseFloat(document.getElementById('calcWeight').value) || 0;
            const price = weight * currentGoldPrice;
            document.getElementById('calcResult').textContent = formatPrice(price) + ' ØªÙˆÙ…Ø§Ù†';
        }

        // Switch tabs
        function switchTab(tab) {
            // Update navigation slider
            updateNavSlider(tab);

            // Scroll to top first (instant)
            if (window.scrollY > 0) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Small delay to let scroll start, then switch content
            setTimeout(() => {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                    content.classList.remove('tab-enter');
                });

                // Show target tab with animation
                let targetTab = null;
                if (tab === 'dashboard') {
                    targetTab = document.getElementById('dashboardTab');
                } else if (tab === 'portfolio') {
                    targetTab = document.getElementById('portfolioTab');
                } else if (tab === 'alerts') {
                    targetTab = document.getElementById('alertsTab');
                }

                if (targetTab) {
                    targetTab.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        targetTab.classList.add('tab-enter');
                    });
                }
            }, 100);
        }

        // Modal functions
        function openAddPortfolioModal() {
            document.getElementById('addPortfolioModal').classList.add('active');
        }

        function closeAddPortfolioModal() {
            document.getElementById('addPortfolioModal').classList.remove('active');
            document.getElementById('newWeight').value = '';
            document.getElementById('newPricePerGram').value = '';
            document.getElementById('newTotalPrice').value = '';
            document.getElementById('newDate').value = '';
            document.getElementById('priceInputType').value = 'per_gram';
            togglePriceInput();
        }

        function openAddAlertModal() {
            document.getElementById('addAlertModal').classList.add('active');
        }

        function closeAddAlertModal() {
            document.getElementById('addAlertModal').classList.remove('active');
            document.getElementById('alertGoldType').value = '18_750';
            document.getElementById('alertType').value = 'above';
            document.getElementById('alertTargetPrice').value = '';
        }

        function openChangeTimeModal() {
            const currentTime = document.getElementById('notificationTime').textContent;
            document.getElementById('newNotificationTime').value = currentTime;
            document.getElementById('changeTimeModal').classList.add('active');
        }

        function closeChangeTimeModal() {
            document.getElementById('changeTimeModal').classList.remove('active');
        }

        // Add portfolio item
        async function addPortfolioItem() {
            const weight = parseFloat(document.getElementById('newWeight').value);
            const date = document.getElementById('newDate').value;
            const priceType = document.getElementById('priceInputType').value;

            let pricePerGram = 0;
            if (priceType === 'per_gram') {
                pricePerGram = parsePriceInput(document.getElementById('newPricePerGram').value);
            } else {
                const totalPrice = parsePriceInput(document.getElementById('newTotalPrice').value);
                if (weight > 0) {
                    pricePerGram = Math.round(totalPrice / weight);
                }
            }

            if (!weight || !pricePerGram || !date) {
                alert('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/portfolio/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        weight: weight,
                        pricePerGram: pricePerGram,
                        purchaseDate: date
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                    closeAddPortfolioModal();
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±Ø§ÛŒÛŒ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Delete portfolio item
        async function deletePortfolioItem(id) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/portfolio/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ø±Ø§ÛŒÛŒ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Add alert
        async function addAlert() {
            const goldType = document.getElementById('alertGoldType').value;
            const alertType = document.getElementById('alertType').value;
            const targetPrice = parsePriceInput(document.getElementById('alertTargetPrice').value);

            if (!targetPrice) {
                alert('Ù„Ø·ÙØ§ Ù‚ÛŒÙ…Øª Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // ØªØ¨Ø¯ÛŒÙ„ goldType Ø¨Ù‡ ÙØ±Ù…Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
            let goldTypeCode = '18';
            let purity = '750';
            if (goldType === '18_740') {
                purity = '740';
            } else if (goldType === '24') {
                goldTypeCode = '24';
                purity = null;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/alerts/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        goldType: goldTypeCode,
                        purity: purity,
                        alertType: alertType,
                        targetPrice: targetPrice
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
                    closeAddAlertModal();
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Delete alert
        async function deleteAlert(id) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/alerts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‡Ø´Ø¯Ø§Ø±');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Change notification time
        async function changeNotificationTime() {
            const newTime = document.getElementById('newNotificationTime').value;

            if (!newTime) {
                alert('Ù„Ø·ÙØ§ Ø³Ø§Ø¹Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/user/notification-time`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        notificationTime: newTime
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø³Ø§Ø¹Øª Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯');
                    document.getElementById('notificationTime').textContent = newTime;
                    closeChangeTimeModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Logout
        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('authUserId');
                userData = null;

                document.getElementById('appPage').classList.remove('active');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('verifyForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';

                document.getElementById('userIdInput').value = '';
                document.getElementById('codeInput').value = '';
            }
        }

        // Back to login
        function backToLogin() {
            document.getElementById('verifyForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('codeInput').value = '';
        }

        // Format price Ø¨Ø§ Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ø§ (Ù‡Ø± 3 Ø±Ù‚Ù…)
        function formatPrice(price) {
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            if (price === null || price === undefined || isNaN(price) || !isFinite(price)) {
                return '0';
            }
            // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ùˆ Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¨Ø§ Ú©Ø§Ù…Ø§
            const rounded = Math.round(price);
            return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Format price input - Ø¬Ø¯Ø§Ø³Ø§Ø² real-time Ø¨Ø±Ø§ÛŒ input Ù‡Ø§
        function formatPriceInput(input) {
            // Ø­Ø°Ù ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ± Ø¹Ø¯Ø¯ÛŒ
            let value = input.value.replace(/[^0-9]/g, '');

            // Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ return
            if (!value) {
                input.value = '';
                return;
            }

            // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ Ùˆ Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¨Ø§ Ú©Ø§Ù…Ø§
            const formatted = parseInt(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            input.value = formatted;
        }

        // Parse price from formatted input
        function parsePriceInput(value) {
            if (!value) return 0;
            // Ø­Ø°Ù Ú©Ø§Ù…Ø§Ù‡Ø§ Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯
            return parseInt(value.replace(/,/g, '')) || 0;
        }

        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        function gregorianToJalali(gDate) {
            if (!gDate) return 'Ù†Ø§Ù…Ø´Ø®Øµ';

            try {
                // ØªØ¨Ø¯ÛŒÙ„ ÙØ±Ù…Øª "YYYY-MM-DD HH:MM:SS" Ø¨Ù‡ ÙØ±Ù…Øª Ù‚Ø§Ø¨Ù„ Ù¾Ø§Ø±Ø³
                const dateStr = gDate.toString().replace(' ', 'T');
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'Ù†Ø§Ù…Ø´Ø®Øµ';

                let gy = date.getFullYear();
                const gm = date.getMonth() + 1;
                const gd = date.getDate();

                let jy, jm, jd;
                const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];

                if (gy > 1600) {
                    jy = 979;
                    gy -= 1600;
                } else {
                    jy = 0;
                    gy -= 621;
                }

                const gy2 = (gm > 2) ? (gy + 1) : gy;
                let days = (365 * gy) + (Math.floor((gy2 + 3) / 4)) - (Math.floor((gy2 + 99) / 100)) + (Math.floor((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
                jy += 33 * Math.floor(days / 12053);
                days %= 12053;
                jy += 4 * Math.floor(days / 1461);
                days %= 1461;

                if (days > 365) {
                    jy += Math.floor((days - 1) / 365);
                    days = (days - 1) % 365;
                }

                if (days < 186) {
                    jm = 1 + Math.floor(days / 31);
                    jd = 1 + (days % 31);
                } else {
                    jm = 7 + Math.floor((days - 186) / 30);
                    jd = 1 + ((days - 186) % 30);
                }

                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');

                return `${jy}/${jm.toString().padStart(2, '0')}/${jd.toString().padStart(2, '0')} - ${hour}:${minute}`;
            } catch (e) {
                console.error('Error converting date:', e);
                return 'Ù†Ø§Ù…Ø´Ø®Øµ';
            }
        }

        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† Developer Tools
        document.addEventListener('keydown', function (e) {
            // F12
            if (e.keyCode === 123) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+I
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+J
            if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
            }
            // Ctrl+U
            if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+C
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                return false;
            }
        });

        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±Ø§Ø³Øª Ú©Ù„ÛŒÚ©
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            return false;
        });
    </script>
</body>

</html>
