<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø·Ù„Ø§ ÛŒØ§Ø± - Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 120px;
            /* Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Ù…Ø­ØªÙˆØ§ */
        }

        /* Login Page */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            font-size: 2.5em;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .login-logo p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #d4af37;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1em;
            font-family: 'Vazirmatn', sans-serif;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(255, 255, 255, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #0f2027;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Main App */
        .app-page {
            display: none;
        }

        .app-page.active {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-info h2 {
            color: #d4af37;
            margin-bottom: 5px;
        }

        .header-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .btn-logout {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-logout:hover {
            background: rgba(255, 59, 48, 0.3);
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            color: #d4af37;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #fff;
            font-size: 1.3em;
            font-weight: 600;
        }

        .stat-value.profit {
            color: #34c759;
        }

        .stat-value.loss {
            color: #ff3b30;
        }

        /* Gold Price Display */
        .price-display {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(244, 208, 63, 0.1) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .price-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .price-value {
            color: #d4af37;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .price-change {
            font-size: 0.95em;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        .price-change.up {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .price-change.down {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        /* Portfolio Items */
        .portfolio-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .portfolio-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .portfolio-item-info {
            flex: 1;
        }

        .portfolio-item-info h4 {
            color: #fff;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .portfolio-item-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            margin: 4px 0;
        }

        .portfolio-item-value {
            text-align: left;
        }

        .portfolio-item-value .current {
            color: #d4af37;
            font-weight: 600;
            font-size: 1em;
        }

        .portfolio-item-value .profit {
            color: #34c759;
            font-size: 0.85em;
            margin-top: 4px;
            font-weight: 500;
        }

        .portfolio-item-value .loss {
            color: #ff3b30;
            font-size: 0.85em;
            margin-top: 4px;
            font-weight: 500;
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .btn-delete:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: scale(1.05);
        }

        /* Alert Items */
        .alert-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .alert-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-type {
            color: #d4af37;
            font-weight: 600;
        }

        .alert-price {
            color: #fff;
            font-size: 1.1em;
        }

        .alert-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .alert-status.active {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .alert-status.inactive {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        /* Calculator */
        .calculator {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .calculator-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .calculator-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-family: 'Vazirmatn', sans-serif;
        }

        .calculator-input input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .calculator-result {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(244, 208, 63, 0.1) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .calculator-result-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .calculator-result-value {
            color: #d4af37;
            font-size: 1.8em;
            font-weight: 700;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background: rgba(15, 32, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 0 5px;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .nav-item.active {
            background: rgba(212, 175, 55, 0.2);
        }

        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 3px;
        }

        .nav-label {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
        }

        .nav-item.active .nav-label {
            color: #d4af37;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #d4af37;
            font-size: 1.3em;
            font-weight: 600;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }

        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .login-card {
                padding: 30px 20px;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .price-value {
                font-size: 1.5em;
            }
        }

        /* Utilities */
        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="absolute top-0 left-1/2"
                style="transform: translateX(-50%); width: 160px; height: 2px; background: linear-gradient(to right, transparent, rgba(156, 163, 175, 0.3), transparent);">
            </div>

            <div class="login-logo">
                <h1>ğŸ† Ø·Ù„Ø§ ÛŒØ§Ø±</h1>
                <p>Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø·Ù„Ø§</p>
            </div>

            <div id="loginForm">
                <!-- How to get ID instruction -->
                <div
                    style="background: rgba(31, 41, 55, 0.5); padding: 16px; border-radius: 16px; border: 1px solid rgba(55, 65, 81, 0.5); text-align: center; margin-bottom: 20px; backdrop-filter: blur(4px);">
                    <p
                        style="color: rgba(156, 163, 175, 0.9); font-size: 0.75em; margin-bottom: 12px; line-height: 1.6;">
                        Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± Ø±Ø¨Ø§Øª ÙˆØ§Ø±Ø¯ Ùˆ Ø§ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯:</p>

                    <div style="background: rgba(17, 24, 39, 0.8); border: 1px solid rgb(75, 85, 99); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='rgba(34, 197, 94, 0.5)'"
                        onmouseout="this.style.borderColor='rgb(75, 85, 99)'" onclick="copyCommand()">
                        <code
                            style="color: rgb(252, 165, 165); font-family: 'Courier New', monospace; letter-spacing: 1.5px; font-weight: 700;">/whatismyid</code>
                        <span id="copyText"
                            style="color: rgb(107, 114, 128); font-size: 0.75em; transition: color 0.3s;">Ú©Ù¾ÛŒ</span>
                    </div>

                    <a href="https://t.me/GoldYarRoBot" target="_blank" rel="noreferrer"
                        style="color: rgb(96, 165, 250); font-size: 0.75em; margin-top: 12px; display: block; text-decoration: none; transition: color 0.3s;"
                        onmouseover="this.style.color='rgb(147, 197, 253)'"
                        onmouseout="this.style.color='rgb(96, 165, 250)'">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… â†’</a>
                </div>

                <div class="input-group">
                    <input type="tel" id="userIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ (User ID)"
                        style="text-align: center; direction: ltr; letter-spacing: 2px; font-family: 'Courier New', monospace; font-size: 1.1em;">
                </div>
                <button class="btn btn-primary" onclick="requestCode()">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
            </div>

            <div id="verifyForm" style="display: none;">
                <div class="input-group">
                    <label for="codeInput">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ 10 Ø±Ù‚Ù…ÛŒ</label>
                    <input type="text" id="codeInput" placeholder="Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                        style="text-align: center; direction: ltr; letter-spacing: 2px; font-family: 'Courier New', monospace;">
                </div>
                <button class="btn btn-primary" onclick="verifyCode()">ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-secondary mt-20" onclick="backToLogin()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appPage" class="app-page">
        <div class="container">
            <div class="header">
                <div class="header-info">
                    <h2 id="userName">Ú©Ø§Ø±Ø¨Ø±</h2>
                    <p id="userId"></p>
                </div>
                <button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <!-- Live Gold Price -->
                <div class="card">
                    <div class="card-title">ğŸ’° Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø·Ù„Ø§</div>
                    <div class="price-display">
                        <div class="price-label">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù… Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø±</div>
                        <div class="price-value" id="currentPrice">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                        <div class="price-change up" id="priceChange">
                            <span id="priceChangeText">--</span>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Summary -->
                <div class="card">
                    <div class="card-title">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡</div>
                            <div class="stat-value" id="totalInvestment">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</div>
                            <div class="stat-value" id="currentValue">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
                            <div class="stat-value profit" id="profitLoss">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ±</div>
                            <div class="stat-value" id="profitPercent">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Gold Calculator -->
                <div class="card">
                    <div class="card-title">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ù‚ÛŒÙ…Øª Ø·Ù„Ø§</div>
                    <div class="calculator">
                        <div class="calculator-input">
                            <input type="number" id="calcWeight" placeholder="ÙˆØ²Ù† (Ú¯Ø±Ù…)" step="0.01"
                                oninput="calculateGoldPrice()">
                        </div>
                        <div class="calculator-result">
                            <div class="calculator-result-label">Ø§Ø±Ø²Ø´ ØªÙ‚Ø±ÛŒØ¨ÛŒ</div>
                            <div class="calculator-result-value" id="calcResult">0 ØªÙˆÙ…Ø§Ù†</div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <div class="card-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ø§Ø¹Ù„Ø§Ù†</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                        <div>
                            <div style="color: #fff; margin-bottom: 5px;">Ø²Ù…Ø§Ù† Ø§Ø¹Ù„Ø§Ù† Ù‚ÛŒÙ…Øª</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em;" id="notificationTime">00:40
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px;"
                            onclick="openChangeTimeModal()">ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª</button>
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolioTab" class="tab-content hidden">
                <!-- Portfolio Summary Card -->
                <div class="card">
                    <div class="card-title">ï¿½ Ø³Ø¨Ø¯ Ø·Ù„Ø§ÛŒ Ø´Ù…Ø§</div>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">ğŸ’° Ø³Ø±Ù…Ø§ÛŒÙ‡</div>
                            <div class="stat-value" id="totalPortfolioInvestment">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">âš–ï¸ Ú©Ù„ Ø·Ù„Ø§</div>
                            <div class="stat-value" id="totalGoldWeight">0 Ú¯Ø±Ù…</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ğŸ’ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</div>
                            <div class="stat-value" id="totalPortfolioValue">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ğŸ“ˆ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
                            <div class="stat-value profit" id="totalPortfolioProfit">0</div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Items -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ’¼ Ù„ÛŒØ³Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</span>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px; font-size: 0.9em;"
                            onclick="openAddPortfolioModal()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                    <div id="portfolioList"></div>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab" class="tab-content hidden">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ù‚ÛŒÙ…Øª</span>
                        <button class="btn btn-primary" style="width: auto; padding: 10px 20px; font-size: 0.9em;"
                            onclick="openAddAlertModal()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                    <div id="alertsList"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-label">Ø®Ø§Ù†Ù‡</div>
            </div>
            <div class="nav-item" onclick="switchTab('portfolio')">
                <div class="nav-icon">ğŸ’¼</div>
                <div class="nav-label">Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
            </div>
            <div class="nav-item" onclick="switchTab('alerts')">
                <div class="nav-icon">ğŸ””</div>
                <div class="nav-label">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</div>
            </div>
        </div>
    </div>

    <!-- Add Portfolio Modal -->
    <div id="addPortfolioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
                <button class="btn-close" onclick="closeAddPortfolioModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>ÙˆØ²Ù† (Ú¯Ø±Ù…)</label>
                    <input type="number" id="newWeight" placeholder="Ù…Ø«Ø§Ù„: 5.5" step="0.01">
                </div>

                <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª -->
                <div class="input-group">
                    <label>Ù†ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª</label>
                    <select id="priceInputType" onchange="togglePriceInput()"
                        style="width: 100%; padding: 12px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.05); color: #fff; font-family: 'Vazirmatn', sans-serif;">
                        <option value="per_gram">Ù‚ÛŒÙ…Øª Ù‡Ø± Ú¯Ø±Ù…</option>
                        <option value="total">Ù‚ÛŒÙ…Øª Ú©Ù„ Ø®Ø±ÛŒØ¯</option>
                    </select>
                </div>

                <div class="input-group" id="pricePerGramGroup">
                    <label>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ Ù‡Ø± Ú¯Ø±Ù… (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="number" id="newPricePerGram" placeholder="Ù…Ø«Ø§Ù„: 5000000">
                </div>

                <div class="input-group" id="totalPriceGroup" style="display: none;">
                    <label>Ù‚ÛŒÙ…Øª Ú©Ù„ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="number" id="newTotalPrice" placeholder="Ù…Ø«Ø§Ù„: 27500000">
                </div>

                <div class="input-group">
                    <label>ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯</label>
                    <input type="text" id="newDate" placeholder="Ù…Ø«Ø§Ù„: 1403/11/20">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addPortfolioItem()">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div id="addAlertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª</div>
                <button class="btn-close" onclick="closeAddAlertModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ø·Ù„Ø§</label>
                    <select id="alertGoldType"
                        style="width: 100%; padding: 12px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.05); color: #fff; font-family: 'Vazirmatn', sans-serif;">
                        <option value="18_750">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (750)</option>
                        <option value="18_740">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (740)</option>
                        <option value="24">Ø·Ù„Ø§ÛŒ 24 Ø¹ÛŒØ§Ø±</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ù†ÙˆØ¹ Ù‡Ø´Ø¯Ø§Ø±</label>
                    <select id="alertType"
                        style="width: 100%; padding: 12px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; background: rgba(255, 255, 255, 0.05); color: #fff; font-family: 'Vazirmatn', sans-serif;">
                        <option value="above">Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø²</option>
                        <option value="below">Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø²</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ù‚ÛŒÙ…Øª Ù‡Ø¯Ù (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="number" id="alertTargetPrice" placeholder="Ù…Ø«Ø§Ù„: 5200000">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addAlert()">Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±</button>
        </div>
    </div>

    <!-- Change Time Modal -->
    <div id="changeTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª Ø§Ø¹Ù„Ø§Ù†</div>
                <button class="btn-close" onclick="closeChangeTimeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Ø³Ø§Ø¹Øª (24 Ø³Ø§Ø¹ØªÙ‡)</label>
                    <input type="time" id="newNotificationTime">
                </div>
            </div>
            <button class="btn btn-primary" onclick="changeNotificationTime()">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://page-teleg.goldyarprice.workers.dev';
        let userData = null;
        let currentGoldPrice = 0;

        // Initialize
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        // Check if already logged in
        const token = localStorage.getItem('authToken');
        if (token) {
            loadUserData();
        }

        // Copy /whatismyid command
        function copyCommand() {
            const command = '/whatismyid';
            navigator.clipboard.writeText(command).then(() => {
                const copyTextEl = document.getElementById('copyText');
                copyTextEl.textContent = 'Ú©Ù¾ÛŒ Ø´Ø¯ âœ“';
                copyTextEl.style.color = 'rgb(34, 197, 94)';

                setTimeout(() => {
                    copyTextEl.textContent = 'Ú©Ù¾ÛŒ';
                    copyTextEl.style.color = 'rgb(107, 114, 128)';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Request verification code
        async function requestCode() {
            const userId = document.getElementById('userIdInput').value.trim();

            if (!userId) {
                alert('Ù„Ø·ÙØ§ Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/request-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: parseInt(userId) })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('verifyForm').style.display = 'block';
                    alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                } else {
                    alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Verify code and login
        async function verifyCode() {
            const userId = document.getElementById('userIdInput').value.trim();
            const code = document.getElementById('codeInput').value.trim();

            if (!code) {
                alert('Ù„Ø·ÙØ§ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/verify-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        code: code
                    })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    loadUserData();
                } else {
                    alert(data.message || 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ú©Ø¯');
            }
        }

        // Load user data
        async function loadUserData() {
            const token = localStorage.getItem('authToken');

            try {
                const response = await fetch(`${API_BASE}/api/user`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    userData = data;

                    // Ù„Ø§Ú¯ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø±ÛŒØ§ÙØªÛŒ
                    console.log('ğŸ“¦ User data received:', {
                        portfolio: {
                            totalInvestment: data.portfolio.totalInvestment,
                            currentValue: data.portfolio.currentValue,
                            profit: data.portfolio.profit,
                            profitPercent: data.portfolio.profitPercent,
                            itemsCount: data.portfolio.items ? data.portfolio.items.length : 0
                        }
                    });

                    // Update UI
                    document.getElementById('userName').textContent = data.user.first_name || 'Ú©Ø§Ø±Ø¨Ø±';
                    document.getElementById('userId').textContent = `Ø´Ù†Ø§Ø³Ù‡: ${data.user.user_id}`;
                    document.getElementById('notificationTime').textContent = data.user.notification_time || '00:40';

                    // Calculate total gold weight
                    let totalWeight = 0;
                    if (data.portfolio.items && data.portfolio.items.length > 0) {
                        totalWeight = data.portfolio.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                    }

                    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø±ÛŒØ§ÙØªÛŒ
                    const totalInvestment = parseFloat(data.portfolio.totalInvestment) || 0;
                    const currentValue = parseFloat(data.portfolio.currentValue) || 0;
                    const profit = parseFloat(data.portfolio.profit) || 0;
                    const profitPercent = parseFloat(data.portfolio.profitPercent) || 0;

                    // Portfolio summary (Dashboard)
                    document.getElementById('totalInvestment').textContent = formatPrice(totalInvestment);
                    document.getElementById('currentValue').textContent = formatPrice(currentValue);

                    const profitLossEl = document.getElementById('profitLoss');
                    profitLossEl.textContent = formatPrice(profit);
                    profitLossEl.className = 'stat-value ' + (profit >= 0 ? 'profit' : 'loss');

                    document.getElementById('profitPercent').textContent = profitPercent.toFixed(2) + '%';

                    // Portfolio Tab Summary - Ù…Ø·Ø§Ø¨Ù‚ Ø±Ø¨Ø§Øª
                    document.getElementById('totalPortfolioInvestment').textContent = formatPrice(totalInvestment);
                    document.getElementById('totalGoldWeight').textContent = totalWeight.toFixed(2) + ' Ú¯Ø±Ù…';
                    document.getElementById('totalPortfolioValue').textContent = formatPrice(currentValue);

                    const totalProfitEl = document.getElementById('totalPortfolioProfit');
                    totalProfitEl.textContent = formatPrice(profit);
                    totalProfitEl.className = 'stat-value ' + (profit >= 0 ? 'profit' : 'loss');

                    // Load portfolio items
                    loadPortfolioItems(data.portfolio.items);

                    // Load alerts
                    loadAlerts(data.alerts);

                    // Show app page
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appPage').classList.add('active');

                    // Load current gold price
                    loadCurrentGoldPrice();
                } else {
                    localStorage.removeItem('authToken');
                    alert('Ù†Ø´Ø³Øª Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
            }
        }

        // Load current gold price
        async function loadCurrentGoldPrice() {
            try {
                const response = await fetch(`${API_BASE}/api/gold-price`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.price) {
                    currentGoldPrice = data.price;
                    document.getElementById('currentPrice').textContent = formatPrice(currentGoldPrice) + ' ØªÙˆÙ…Ø§Ù†';

                    const changeEl = document.getElementById('priceChange');
                    const changeTextEl = document.getElementById('priceChangeText');

                    if (data.changePercent >= 0) {
                        changeEl.className = 'price-change up';
                        changeTextEl.textContent = `â–² ${data.changePercent.toFixed(2)}%`;
                    } else {
                        changeEl.className = 'price-change down';
                        changeTextEl.textContent = `â–¼ ${Math.abs(data.changePercent).toFixed(2)}%`;
                    }

                    // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ø¨Ø¹ Ù‚ÛŒÙ…Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                    console.log('ğŸ’° Price source:', data.source || 'unknown');

                    // Update portfolio values with current price
                    if (userData && userData.portfolio && userData.portfolio.items) {
                        recalculatePortfolioValues();
                    }
                } else {
                    throw new Error('Invalid API response');
                }
            } catch (error) {
                console.error('âŒ Failed to fetch gold price from API:', error);

                // Fallback: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ±ØªÙÙˆÙ„ÛŒÙˆ
                if (userData && userData.portfolio && userData.portfolio.items && userData.portfolio.items.length > 0) {
                    console.log('ğŸ“Š Using portfolio data as fallback');

                    const totalValue = userData.portfolio.items.reduce((sum, item) => sum + item.current_value, 0);
                    const totalWeight = userData.portfolio.items.reduce((sum, item) => sum + item.weight, 0);

                    if (totalWeight > 0) {
                        currentGoldPrice = Math.round(totalValue / totalWeight);
                        document.getElementById('currentPrice').textContent = formatPrice(currentGoldPrice) + ' ØªÙˆÙ…Ø§Ù†';

                        const changeEl = document.getElementById('priceChange');
                        const changeTextEl = document.getElementById('priceChangeText');
                        const changePercent = userData.portfolio.profitPercent || 0;

                        if (changePercent >= 0) {
                            changeEl.className = 'price-change up';
                            changeTextEl.textContent = `â–² ${changePercent.toFixed(2)}%`;
                        } else {
                            changeEl.className = 'price-change down';
                            changeTextEl.textContent = `â–¼ ${Math.abs(changePercent).toFixed(2)}%`;
                        }

                        // Update portfolio display
                        recalculatePortfolioValues();
                    } else {
                        document.getElementById('currentPrice').textContent = 'Ù‚ÛŒÙ…Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
                    }
                } else {
                    document.getElementById('currentPrice').textContent = 'Ù‚ÛŒÙ…Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
                    document.getElementById('priceChangeText').textContent = '--';
                }
            }
        }

        // Recalculate portfolio values with current gold price
        function recalculatePortfolioValues() {
            if (!userData || !userData.portfolio || !userData.portfolio.items || !currentGoldPrice) return;

            let totalWeight = 0;
            let totalInvestment = 0;
            let totalCurrentValue = 0;

            userData.portfolio.items.forEach(item => {
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù‡Ø³ØªÙ†Ø¯
                const weight = parseFloat(item.weight) || 0;
                const purchaseValue = parseFloat(item.purchase_value) || 0;

                totalWeight += weight;
                totalInvestment += purchaseValue;
                const currentValue = weight * currentGoldPrice;
                totalCurrentValue += currentValue;
            });

            const profit = totalCurrentValue - totalInvestment;
            const profitPercent = totalInvestment > 0 ? (profit / totalInvestment) * 100 : 0;

            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù‡Ø³ØªÙ†Ø¯
            const safeProfit = isFinite(profit) ? profit : 0;
            const safeProfitPercent = isFinite(profitPercent) ? profitPercent : 0;
            const safeTotalInvestment = isFinite(totalInvestment) ? totalInvestment : 0;
            const safeTotalCurrentValue = isFinite(totalCurrentValue) ? totalCurrentValue : 0;
            const safeTotalWeight = isFinite(totalWeight) ? totalWeight : 0;

            // Update dashboard
            document.getElementById('totalInvestment').textContent = formatPrice(safeTotalInvestment);
            document.getElementById('currentValue').textContent = formatPrice(safeTotalCurrentValue);
            const profitLossEl = document.getElementById('profitLoss');
            profitLossEl.textContent = formatPrice(safeProfit);
            profitLossEl.className = 'stat-value ' + (safeProfit >= 0 ? 'profit' : 'loss');
            document.getElementById('profitPercent').textContent = safeProfitPercent.toFixed(2) + '%';

            // Update portfolio summary - Ù…Ø·Ø§Ø¨Ù‚ Ø±Ø¨Ø§Øª
            document.getElementById('totalPortfolioInvestment').textContent = formatPrice(safeTotalInvestment);
            document.getElementById('totalGoldWeight').textContent = safeTotalWeight.toFixed(2) + ' Ú¯Ø±Ù…';
            document.getElementById('totalPortfolioValue').textContent = formatPrice(safeTotalCurrentValue);
            const totalProfitEl = document.getElementById('totalPortfolioProfit');
            totalProfitEl.textContent = formatPrice(safeProfit);
            totalProfitEl.className = 'stat-value ' + (safeProfit >= 0 ? 'profit' : 'loss');

            // Update portfolio items display
            loadPortfolioItems(userData.portfolio.items);
        }

        // Load portfolio items
        function loadPortfolioItems(items) {
            const container = document.getElementById('portfolioList');

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p></div>';
                return;
            }

            container.innerHTML = items.map((item, index) => {
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ±
                const weight = parseFloat(item.weight) || 0;
                const pricePerGram = parseFloat(item.price_per_gram) || 0;
                const purchaseValue = parseFloat(item.purchase_value) || 0;
                const itemCurrentValue = currentGoldPrice ? weight * currentGoldPrice : (parseFloat(item.current_value) || 0);

                const profit = itemCurrentValue - purchaseValue;
                const profitClass = profit >= 0 ? 'profit' : 'loss';
                const profitSign = profit >= 0 ? '+' : '';
                const profitPercent = purchaseValue > 0 ? ((profit / purchaseValue) * 100).toFixed(2) : '0.00';

                return `
                    <div class="portfolio-item" style="border-right: 3px solid ${profit >= 0 ? '#34c759' : '#ff3b30'};">
                        <div class="portfolio-item-info">
                            <h4 style="display: flex; align-items: center; gap: 8px;">
                                <span style="background: rgba(212, 175, 55, 0.2); padding: 4px 12px; border-radius: 8px; font-size: 0.9em;">${weight.toFixed(2)} Ú¯Ø±Ù…</span>
                                <span style="font-size: 0.85em; color: rgba(255, 255, 255, 0.7);">Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø±</span>
                            </h4>
                            <p style="margin-top: 8px;">ğŸ’° Ø®Ø±ÛŒØ¯: ${formatPrice(pricePerGram)} ØªÙˆÙ…Ø§Ù†/Ú¯Ø±Ù…</p>
                            <p style="font-size: 0.8em; color: rgba(255, 255, 255, 0.5); margin-top: 4px;">ğŸ“… ${item.purchase_date || 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                            <div class="portfolio-item-value" style="text-align: left;">
                                <div class="current" style="font-size: 1.1em;">${formatPrice(itemCurrentValue)} ØªÙˆÙ…Ø§Ù†</div>
                                <div class="${profitClass}" style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                                    <span>${profitSign}${formatPrice(profit)}</span>
                                    <span style="font-size: 0.85em; opacity: 0.8;">(${profitSign}${profitPercent}%)</span>
                                </div>
                            </div>
                            <button class="btn-delete" onclick="deletePortfolioItem(${item.id})" style="font-size: 0.8em; padding: 6px 12px;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load alerts
        function loadAlerts(alerts) {
            const container = document.getElementById('alertsList');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”•</div><p>Ù‡Ø´Ø¯Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p></div>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const statusClass = alert.is_triggered ? 'inactive' : 'active';
                const statusText = alert.is_triggered ? 'ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡' : 'ÙØ¹Ø§Ù„';
                const typeText = alert.alert_type === 'above' ? 'Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø²' : 'Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø²';

                // ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… Ø·Ù„Ø§
                let goldName = 'Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (750)';
                if (alert.gold_type === '24') {
                    goldName = 'Ø·Ù„Ø§ÛŒ 24 Ø¹ÛŒØ§Ø±';
                } else if (alert.purity === '740') {
                    goldName = 'Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø± (740)';
                }

                return `
                    <div class="alert-item">
                        <div class="alert-item-header">
                            <div>
                                <div class="alert-type">${goldName} - ${typeText}</div>
                                <div class="alert-price">${formatPrice(alert.target_price)} ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="alert-status ${statusClass}">${statusText}</div>
                                <button class="btn-delete" onclick="deleteAlert(${alert.id})" style="padding: 4px 8px; font-size: 0.75em;">Ø­Ø°Ù</button>
                            </div>
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em;">
                            Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: ${alert.created_at}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle price input type
        function togglePriceInput() {
            const type = document.getElementById('priceInputType').value;
            const perGramGroup = document.getElementById('pricePerGramGroup');
            const totalGroup = document.getElementById('totalPriceGroup');

            if (type === 'per_gram') {
                perGramGroup.style.display = 'block';
                totalGroup.style.display = 'none';
            } else {
                perGramGroup.style.display = 'none';
                totalGroup.style.display = 'block';
            }
        }

        // Calculate gold price
        function calculateGoldPrice() {
            const weight = parseFloat(document.getElementById('calcWeight').value) || 0;
            const price = weight * currentGoldPrice;
            document.getElementById('calcResult').textContent = formatPrice(price) + ' ØªÙˆÙ…Ø§Ù†';
        }

        // Switch tabs
        function switchTab(tab) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            if (tab === 'dashboard') {
                document.getElementById('dashboardTab').classList.remove('hidden');
            } else if (tab === 'portfolio') {
                document.getElementById('portfolioTab').classList.remove('hidden');
            } else if (tab === 'alerts') {
                document.getElementById('alertsTab').classList.remove('hidden');
            }
        }

        // Modal functions
        function openAddPortfolioModal() {
            document.getElementById('addPortfolioModal').classList.add('active');
        }

        function closeAddPortfolioModal() {
            document.getElementById('addPortfolioModal').classList.remove('active');
            document.getElementById('newWeight').value = '';
            document.getElementById('newPricePerGram').value = '';
            document.getElementById('newTotalPrice').value = '';
            document.getElementById('newDate').value = '';
            document.getElementById('priceInputType').value = 'per_gram';
            togglePriceInput();
        }

        function openAddAlertModal() {
            document.getElementById('addAlertModal').classList.add('active');
        }

        function closeAddAlertModal() {
            document.getElementById('addAlertModal').classList.remove('active');
            document.getElementById('alertGoldType').value = '18_750';
            document.getElementById('alertType').value = 'above';
            document.getElementById('alertTargetPrice').value = '';
        }

        function openChangeTimeModal() {
            const currentTime = document.getElementById('notificationTime').textContent;
            document.getElementById('newNotificationTime').value = currentTime;
            document.getElementById('changeTimeModal').classList.add('active');
        }

        function closeChangeTimeModal() {
            document.getElementById('changeTimeModal').classList.remove('active');
        }

        // Add portfolio item
        async function addPortfolioItem() {
            const weight = parseFloat(document.getElementById('newWeight').value);
            const date = document.getElementById('newDate').value;
            const priceType = document.getElementById('priceInputType').value;

            let pricePerGram = 0;
            if (priceType === 'per_gram') {
                pricePerGram = parseFloat(document.getElementById('newPricePerGram').value);
            } else {
                const totalPrice = parseFloat(document.getElementById('newTotalPrice').value);
                if (weight > 0) {
                    pricePerGram = Math.round(totalPrice / weight);
                }
            }

            if (!weight || !pricePerGram || !date) {
                alert('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/portfolio/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        weight: weight,
                        pricePerGram: pricePerGram,
                        purchaseDate: date
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                    closeAddPortfolioModal();
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±Ø§ÛŒÛŒ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Delete portfolio item
        async function deletePortfolioItem(id) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/portfolio/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ø±Ø§ÛŒÛŒ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Add alert
        async function addAlert() {
            const goldType = document.getElementById('alertGoldType').value;
            const alertType = document.getElementById('alertType').value;
            const targetPrice = parseFloat(document.getElementById('alertTargetPrice').value);

            if (!targetPrice) {
                alert('Ù„Ø·ÙØ§ Ù‚ÛŒÙ…Øª Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // ØªØ¨Ø¯ÛŒÙ„ goldType Ø¨Ù‡ ÙØ±Ù…Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
            let goldTypeCode = '18';
            let purity = '750';
            if (goldType === '18_740') {
                purity = '740';
            } else if (goldType === '24') {
                goldTypeCode = '24';
                purity = null;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/alerts/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        goldType: goldTypeCode,
                        purity: purity,
                        alertType: alertType,
                        targetPrice: targetPrice
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');
                    closeAddAlertModal();
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Delete alert
        async function deleteAlert(id) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/alerts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    // Ø±ÙØ±Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    loadUserData();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‡Ø´Ø¯Ø§Ø±');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Change notification time
        async function changeNotificationTime() {
            const newTime = document.getElementById('newNotificationTime').value;

            if (!newTime) {
                alert('Ù„Ø·ÙØ§ Ø³Ø§Ø¹Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/api/user/notification-time`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        notificationTime: newTime
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ø³Ø§Ø¹Øª Ø§Ø¹Ù„Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯');
                    document.getElementById('notificationTime').textContent = newTime;
                    closeChangeTimeModal();
                } else {
                    alert(data.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø³Ø§Ø¹Øª');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
            }
        }

        // Logout
        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                localStorage.removeItem('authToken');
                userData = null;

                document.getElementById('appPage').classList.remove('active');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('verifyForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';

                document.getElementById('userIdInput').value = '';
                document.getElementById('codeInput').value = '';
            }
        }

        // Back to login
        function backToLogin() {
            document.getElementById('verifyForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('codeInput').value = '';
        }

        // Format price
        function formatPrice(price) {
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            if (price === null || price === undefined || isNaN(price) || !isFinite(price)) {
                return '0';
            }
            return Math.round(price).toLocaleString('fa-IR');
        }
    </script>
</body>

</html>
